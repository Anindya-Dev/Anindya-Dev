name: Refresh GitHub profile stats

on:
  schedule:
    - cron: '0 3 * * *' # 03:00 UTC keeps API usage away from peak traffic
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh:
    name: Update stat assets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Regenerate SVG metrics
        env:
          GH_USERNAME: Anindya-Dev
        run: |
          set -euo pipefail
          mkdir -p assets/stats

          cache_bust="$(date +%s)" # cache-busting so CDN-sourced SVGs refresh

          # helper adds resilient retries to absorb sporadic 5xx responses from upstream badge services
          fetch_card() {
            local label="$1"
            local url="$2"
            local destination="$3"

            echo "Downloading ${label}"
            # tolerate transient 500s without failing the entire workflow
            curl \
              --retry 5 --retry-delay 10 --retry-all-errors \
              --fail --silent --show-error --location \
              "${url}&_=${cache_bust}" \
              --output "${destination}"
          }

          fetch_card "GitHub profile summary" \
            "https://github-readme-stats.vercel.app/api?username=${GH_USERNAME}&count_private=true&show_icons=true&theme=radical&cache_seconds=1800" \
            assets/stats/github-stats.svg

          fetch_card "Top languages card" \
            "https://github-readme-stats.vercel.app/api/top-langs/?username=${GH_USERNAME}&layout=compact&theme=radical&langs_count=8" \
            assets/stats/top-languages.svg

          fetch_card "Contribution streak card" \
            "https://streak-stats.demolab.com/?user=${GH_USERNAME}&theme=radical&hide_border=true&date_format=%5BY.%5Dn.j" \
            assets/stats/contribution-streak.svg

          fetch_card "Contribution activity graph" \
            "https://github-readme-activity-graph.vercel.app/graph?username=${GH_USERNAME}&bg_color=0d1117&color=38bdf8&line=6366f1&point=22d3ee&hide_border=true&custom_title=Contribution%20Activity" \
            assets/stats/activity-graph.svg


      - name: Commit and push changes
        run: |
          set -euo pipefail
          if git status --short | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add assets/stats/
            git commit -m "chore: refresh GitHub stats"
            git push
          else
            echo "No stat updates detected"
          fi
